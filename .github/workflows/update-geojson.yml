name: üöÄ Update GeoJSON
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      - name: üöÄ Fusion des sources
        env:
          GRIST_DOC_ID: ${{ secrets.GRIST_DOC_ID }}
          GRIST_API_KEY: ${{ secrets.GRIST_API_KEY }}
        run: |
          node scripts/grist-to-geojson.js
      
      - name: ‚òÅÔ∏è Upload vers G√©oBretagne (WebDAV)
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          echo "üöÄ Upload vers G√©oBretagne..."
          
          # Upload direct du fichier GeoJSON (sans cr√©er de dossiers)
          echo "üì§ Upload de signalements.geojson..."
          HTTP_CODE=$(curl -w "%{http_code}" -o /dev/null -s -T signalements.geojson \
               -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
               "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/signalements.geojson")
          
          if [ $HTTP_CODE -eq 201 ] || [ $HTTP_CODE -eq 204 ]; then
            echo "‚úÖ signalements.geojson upload√© avec succ√®s (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Erreur upload - Code HTTP: $HTTP_CODE"
            exit 1
          fi
          
          # Upload des m√©tadonn√©es
          if [ -f metadata.json ]; then
            echo "üì§ Upload de metadata.json..."
            HTTP_CODE_META=$(curl -w "%{http_code}" -o /dev/null -s -T metadata.json \
                 -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                 "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/metadata.json")
            
            if [ $HTTP_CODE_META -eq 201 ] || [ $HTTP_CODE_META -eq 204 ]; then
              echo "‚úÖ metadata.json upload√© avec succ√®s (HTTP $HTTP_CODE_META)"
            else
              echo "‚ö†Ô∏è Erreur upload metadata - Code HTTP: $HTTP_CODE_META"
            fi
          fi
          
          echo " Upload vers le cloud G√©oBretagne termin√© !"
          echo " Fichiers disponibles dans: App Routes_coupees_inondation/data/"
          
          # Upload des archives
          if [ -d archives ]; then
            echo ""
            echo "üì¶ Upload des archives..."
            
            # Cr√©er le dossier archives s'il n'existe pas
            echo "üìÅ Cr√©ation du dossier archives..."
            curl -X MKCOL -s \
                 -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                 "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/archives/" || true
            
            # Upload de tous les fichiers GeoJSON d'archive
            for file in archives/*.geojson; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "üì§ Upload de $filename..."
                HTTP_CODE_ARCH=$(curl -w "%{http_code}" -o /dev/null -s -T "$file" \
                     -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                     "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/archives/$filename")
                
                if [ $HTTP_CODE_ARCH -eq 201 ] || [ $HTTP_CODE_ARCH -eq 204 ]; then
                  echo "‚úÖ $filename upload√© (HTTP $HTTP_CODE_ARCH)"
                else
                  echo "‚ö†Ô∏è Erreur upload $filename - Code HTTP: $HTTP_CODE_ARCH"
                fi
              fi
            done
            
            # Upload de last_run.json
            if [ -f archives/last_run.json ]; then
              echo "üì§ Upload de last_run.json..."
              HTTP_CODE_LAST=$(curl -w "%{http_code}" -o /dev/null -s -T archives/last_run.json \
                   -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                   "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/archives/last_run.json")
              
              if [ $HTTP_CODE_LAST -eq 201 ] || [ $HTTP_CODE_LAST -eq 204 ]; then
                echo "‚úÖ last_run.json upload√© (HTTP $HTTP_CODE_LAST)"
              else
                echo "‚ö†Ô∏è Erreur upload last_run.json - Code HTTP: $HTTP_CODE_LAST"
              fi
            fi
            
            echo "‚úÖ Upload des archives termin√© !"
          else
            echo "‚ÑπÔ∏è Aucun dossier archives trouv√©"
          fi
      
      - name: Push GeoJSON
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add signalements.geojson metadata.json
          
          # Ajouter les archives si elles existent
          if [ -d archives ]; then
            git add archives/*.geojson archives/last_run.json || true
          fi
          
          git commit -m "üîÑ Update GeoJSON $(date)" || true
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
