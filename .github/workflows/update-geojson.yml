name: ğŸš€ Update GeoJSON

on:
  schedule:
    - cron: '*/30 * * * *'  # ExÃ©cution toutes les 30 minutes - modifier ici pour changer la frÃ©quence
  workflow_dispatch:  # Permet de lancer manuellement le workflow

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Version de Node.js - changer ici si besoin d'une autre version
      
      - name: Install dependencies
        run: npm install
      
      - name: ğŸš€ Fusion des sources
        env:
          GRIST_DOC_ID: ${{ secrets.GRIST_DOC_ID }}      # Ã€ configurer dans GitLab Settings > CI/CD > Variables
          GRIST_API_KEY: ${{ secrets.GRIST_API_KEY }}    # Ã€ configurer dans GitLab Settings > CI/CD > Variables
        run: |
          node scripts/grist-to-geojson.js  # Chemin vers le script - modifier si le script est ailleurs
      
      - name: â˜ï¸ Upload vers GÃ©oBretagne (WebDAV)
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}              # URL du serveur WebDAV - Ã  configurer dans Variables
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}    # Username WebDAV - Ã  configurer dans Variables
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}    # Password WebDAV - Ã  configurer dans Variables
        run: |
          echo "ğŸš€ Upload vers GÃ©oBretagne..."
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # CRÃ‰ATION DES DOSSIERS SUR LE SERVEUR WEBDAV
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ğŸ“ CrÃ©ation de la structure de dossiers..."
          
          # CrÃ©er data/ - MODIFIER ICI le chemin si la structure change
          curl -X MKCOL -s \
               -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
               "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/" || true
          
          # CrÃ©er data/github/ - MODIFIER ICI le chemin si la structure change
          curl -X MKCOL -s \
               -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
               "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/github/" || true
          
          echo "âœ… Structure de dossiers crÃ©Ã©e"
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # UPLOAD DU FICHIER GEOJSON PRINCIPAL
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ğŸ“¤ Upload de signalements.geojson..."
          
          # MODIFIER ICI : le nom du fichier (signalements.geojson) et le chemin de destination
          HTTP_CODE=$(curl -w "%{http_code}" -o /dev/null -s -T signalements.geojson \
               -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
               "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/github/signalements.geojson")
          
          # VÃ©rification du code HTTP (201=crÃ©Ã©, 204=mis Ã  jour)
          if [ $HTTP_CODE -eq 201 ] || [ $HTTP_CODE -eq 204 ]; then
            echo "âœ… signalements.geojson uploadÃ© avec succÃ¨s (HTTP $HTTP_CODE)"
          else
            echo "âŒ Erreur upload - Code HTTP: $HTTP_CODE"
            exit 1  # ArrÃªte le workflow en cas d'erreur
          fi
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # UPLOAD DES MÃ‰TADONNÃ‰ES
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ -f metadata.json ]; then  # VÃ©rifie que le fichier existe
            echo "ğŸ“¤ Upload de metadata.json..."
            
            # MODIFIER ICI : le nom du fichier et le chemin de destination
            HTTP_CODE_META=$(curl -w "%{http_code}" -o /dev/null -s -T metadata.json \
                 -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                 "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/github/metadata.json")
            
            if [ $HTTP_CODE_META -eq 201 ] || [ $HTTP_CODE_META -eq 204 ]; then
              echo "âœ… metadata.json uploadÃ© avec succÃ¨s (HTTP $HTTP_CODE_META)"
            else
              echo "âš ï¸ Erreur upload metadata - Code HTTP: $HTTP_CODE_META"
            fi
            echo ""
          fi
          
          echo "âœ… Upload vers le cloud GÃ©oBretagne terminÃ© !"
          echo "ğŸ“ Fichiers disponibles dans: App Routes_coupees_inondation/data/github"
          echo ""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # UPLOAD DES ARCHIVES
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ -d archives ]; then  # VÃ©rifie que le dossier archives existe
            echo "ğŸ“¦ Upload des archives..."
            echo ""
            
            # CrÃ©er le dossier archives/ - MODIFIER ICI le chemin si nÃ©cessaire
            echo "ğŸ“ CrÃ©ation du dossier archives..."
            curl -X MKCOL -s \
                 -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                 "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/github/archives/" || true
            echo ""
            
            # Upload de tous les fichiers .geojson du dossier archives
            for file in archives/*.geojson; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "ğŸ“¤ Upload de $filename..."
                
                # MODIFIER ICI le chemin de destination si nÃ©cessaire
                HTTP_CODE_ARCH=$(curl -w "%{http_code}" -o /dev/null -s -T "$file" \
                     -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                     "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/github/archives/$filename")
                
                if [ $HTTP_CODE_ARCH -eq 201 ] || [ $HTTP_CODE_ARCH -eq 204 ]; then
                  echo "âœ… $filename uploadÃ© (HTTP $HTTP_CODE_ARCH)"
                else
                  echo "âš ï¸ Erreur upload $filename - Code HTTP: $HTTP_CODE_ARCH"
                fi
              fi
            done
            echo ""
            
            # Upload du fichier last_run.json
            if [ -f archives/last_run.json ]; then
              echo "ğŸ“¤ Upload de last_run.json..."
              
              # MODIFIER ICI le chemin de destination si nÃ©cessaire
              HTTP_CODE_LAST=$(curl -w "%{http_code}" -o /dev/null -s -T archives/last_run.json \
                   -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                   "${WEBDAV_URL}/App%20Routes_coupees_inondation/data/github/archives/last_run.json")
              
              if [ $HTTP_CODE_LAST -eq 201 ] || [ $HTTP_CODE_LAST -eq 204 ]; then
                echo "âœ… last_run.json uploadÃ© (HTTP $HTTP_CODE_LAST)"
              else
                echo "âš ï¸ Erreur upload last_run.json - Code HTTP: $HTTP_CODE_LAST"
              fi
              echo ""
            fi
            
            echo "âœ… Upload des archives terminÃ© !"
          else
            echo "â„¹ï¸ Aucun dossier archives trouvÃ©"
          fi
          
          echo ""
          echo "ğŸ‰ Tous les uploads sont terminÃ©s !"
