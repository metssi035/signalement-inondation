name: üöÄ Update GeoJSON
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm install
      - name: üöÄ Fusion des 3 sources (Grist 35 + CD44 + Rennes M√©tropole)
        env:
          GRIST_DOC_ID: ${{ secrets.GRIST_DOC_ID }}
          GRIST_API_KEY: ${{ secrets.GRIST_API_KEY }}
        run: |
          node scripts/grist-to-geojson.js
      
      - name: ‚òÅÔ∏è Upload vers G√©oBretagne (WebDAV)
        env:
          WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
          WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
          WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        run: |
          echo "üöÄ Upload vers G√©oBretagne..."
          
          # Cr√©er le dossier data s'il n'existe pas
          echo "üìÅ Cr√©ation/v√©rification du dossier data..."
          curl -X MKCOL -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
               "${WEBDAV_URL}/data" 2>/dev/null || echo "Dossier existe d√©j√† ou cr√©√©"
          
          # Upload du fichier GeoJSON dans le dossier data
          echo "üì§ Upload de signalements.geojson..."
          HTTP_CODE=$(curl -w "%{http_code}" -o /dev/null -s -T signalements.geojson \
               -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
               "${WEBDAV_URL}/data/signalements.geojson")
          
          if [ $HTTP_CODE -eq 201 ] || [ $HTTP_CODE -eq 204 ]; then
            echo "‚úÖ signalements.geojson upload√© (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Upload termin√© avec code HTTP: $HTTP_CODE"
            exit 1
          fi
          
          # Upload des m√©tadonn√©es
          if [ -f metadata.json ]; then
            echo "üì§ Upload de metadata.json..."
            HTTP_CODE_META=$(curl -w "%{http_code}" -o /dev/null -s -T metadata.json \
                 -u "${WEBDAV_USERNAME}:${WEBDAV_PASSWORD}" \
                 "${WEBDAV_URL}/data/metadata.json")
            
            if [ $HTTP_CODE_META -eq 201 ] || [ $HTTP_CODE_META -eq 204 ]; then
              echo "‚úÖ metadata.json upload√© (HTTP $HTTP_CODE_META)"
            else
              echo "‚ö†Ô∏è Upload metadata avec code HTTP: $HTTP_CODE_META"
            fi
          fi
          
          echo "üéâ Upload vers G√©oBretagne termin√© !"
          echo "üìç Fichiers disponibles √†: ${WEBDAV_URL}/data/"
      
      - name: Push GeoJSON
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add signalements.geojson metadata.json
          git commit -m "üîÑ Update GeoJSON $(date)" || true
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
